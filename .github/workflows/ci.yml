name: CI - Quality Gate for Pull Requests

# Trigger apenas em Pull Requests para main e development/simplification
# Sem deploy automÃ¡tico - apenas validaÃ§Ã£o de qualidade
on:
  pull_request:
    branches:
      - main
      - 'development/*'
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest

    # Pular se for draft PR
    if: github.event.pull_request.draft == false

    steps:
    - name: ğŸ“ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ” ESLint - Code Quality Check
      run: npm run lint

    - name: ğŸ—ï¸ TypeScript - Build Check
      run: npm run build

    - name: ğŸ§ª Tests - Unit & Integration
      run: npm run test:run
      continue-on-error: false

    # ComentÃ¡rio no PR com resultado
    - name: ğŸ’¬ PR Quality Report
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          // Remove comentÃ¡rios anteriores do bot
          const botComments = comments.filter(comment =>
            comment.user.type === 'Bot' && comment.body.includes('ğŸ¯ Quality Gate')
          );

          for (const comment of botComments) {
            await github.rest.issues.deleteComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: comment.id,
            });
          }

          // Status do job
          const conclusion = '${{ job.status }}';
          const emoji = conclusion === 'success' ? 'âœ…' : 'âŒ';
          const status = conclusion === 'success' ? 'PASSOU' : 'FALHOU';

          const body = `## ğŸ¯ Quality Gate - ${status} ${emoji}

**Resultados da AnÃ¡lise:**
- **ESLint:** ${conclusion === 'success' ? 'âœ… Sem problemas' : 'âŒ Verificar erros'}
- **TypeScript:** ${conclusion === 'success' ? 'âœ… Build OK' : 'âŒ Build falhou'}
- **Testes:** ${conclusion === 'success' ? 'âœ… Todos passando' : 'âŒ Testes falharam'}

${conclusion === 'success' ?
  'ğŸš€ **Pull Request aprovado para merge!**' :
  'âš ï¸ **Corrija os problemas antes do merge**'
}

---
*Executado automaticamente pelo GitHub Actions*`;

          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

  # Job separado para anÃ¡lise de seguranÃ§a (opcional)
  security-scan:
    name: Security Analysis
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
    - name: ğŸ“ Checkout
      uses: actions/checkout@v4

    - name: ğŸ”’ npm audit
      run: |
        npm audit --audit-level moderate || echo "Security vulnerabilities found - review required"

    - name: ğŸ“Š Bundle Size Analysis
      run: |
        npm ci
        npm run build
        echo "Build size analysis completed"