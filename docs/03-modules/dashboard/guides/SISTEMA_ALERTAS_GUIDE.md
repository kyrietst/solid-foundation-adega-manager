# Sistema de Alertas Inteligentes - Adega Manager

## üìã Vis√£o Geral

O Sistema de Alertas Inteligentes do Adega Manager √© uma funcionalidade enterprise que monitora automaticamente dados cr√≠ticos do sistema e gera alertas baseados em condi√ß√µes predefinidas. Todos os alertas s√£o gerados a partir de **dados reais** do banco de dados Supabase, garantindo precis√£o e relev√¢ncia.

## üèóÔ∏è Arquitetura do Sistema

### Componentes Principais

```
src/features/dashboard/
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ useSmartAlerts.ts          # Hook principal de gera√ß√£o de alertas
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îî‚îÄ‚îÄ AlertsPanel.tsx            # Componente de exibi√ß√£o dos alertas
‚îî‚îÄ‚îÄ types/
    ‚îî‚îÄ‚îÄ Alert.ts                   # Interfaces TypeScript
```

### Fluxo de Dados

```mermaid
graph TD
    A[useSmartAlerts Hook] --> B[Supabase Queries]
    B --> C[Processamento de Dados]
    C --> D[Gera√ß√£o de Alertas]
    D --> E[AlertsPanel Component]
    E --> F[Navega√ß√£o Contextual]
    F --> G[P√°ginas Espec√≠ficas]
```

## üéØ Tipos de Alertas Implementados

### 1. **Alertas de Estoque** 
**Severidade:** CRITICAL / WARNING

#### üî¥ Produtos sem Estoque (CRITICAL)
- **Condi√ß√£o:** `stock_quantity = 0`
- **Query:** `get_low_stock_products` RPC
- **Navega√ß√£o:** `/inventory?filter=zero-stock`
- **Formato:** `{count} produto(s) sem estoque`

#### üü° Produtos Abaixo do M√≠nimo (WARNING)
- **Condi√ß√£o:** `stock_quantity > 0 AND stock_quantity <= min_stock`
- **Query:** `get_low_stock_products` RPC
- **Navega√ß√£o:** `/inventory?filter=low-stock`
- **Formato:** `{count} produto(s) abaixo do m√≠nimo`

### 2. **Alertas Financeiros**
**Severidade:** WARNING / INFO

#### üí∞ Contas em Atraso +30 Dias (WARNING)
- **Condi√ß√£o:** `due_date < (CURRENT_DATE - INTERVAL '30 days')`
- **Tabela:** `accounts_receivable`
- **Navega√ß√£o:** `/reports?tab=financial&filter=overdue-30`
- **Formato:** `R$ {valor} em atraso +30 dias`

#### üìÖ Contas em Atraso Recente (INFO)
- **Condi√ß√£o:** `due_date < CURRENT_DATE`
- **Tabela:** `accounts_receivable`
- **Navega√ß√£o:** `/reports?tab=financial&filter=overdue`
- **Formato:** `R$ {valor} em atraso recente`

### 3. **Alertas de CRM**
**Severidade:** INFO

#### üë• Clientes Inativos (INFO)
- **Condi√ß√£o:** `last_purchase < (CURRENT_DATE - INTERVAL '60 days') OR last_purchase IS NULL`
- **Tabela:** `customers`
- **Navega√ß√£o:** `/customers?filter=inactive-60d`
- **Formato:** `{count} cliente(s) inativo(s)`

### 4. **Alertas de Invent√°rio**
**Severidade:** INFO

#### üì¶ Produtos sem Giro (INFO)
- **Condi√ß√£o:** `price > 50 AND stock > 0 AND no sales in last 30 days`
- **Tabelas:** `products`, `sales`, `sale_items`
- **Navega√ß√£o:** `/inventory?filter=dead-stock`
- **Formato:** `{count} produto(s) sem giro`

## üìä Interface Alert

```typescript
export interface Alert {
  id: string;                    // Identificador √∫nico
  severity: 'info' | 'warning' | 'critical';
  title: string;                 // T√≠tulo principal do alerta
  description?: string;          // Descri√ß√£o adicional
  href?: string;                 // URL de navega√ß√£o
  count?: number;                // Contador de itens afetados
  icon?: string;                 // Emoji/√≠cone visual
}

export interface AlertsData {
  alerts: Alert[];               // Array de alertas
  criticalCount: number;         // Contador de alertas cr√≠ticos
  warningCount: number;          // Contador de alertas de aten√ß√£o
  infoCount: number;             // Contador de alertas informativos
  inventoryTotalValue?: number;  // Valor total do estoque
}
```

## üîß Hook useSmartAlerts

### Configura√ß√£o de Cache
```typescript
queryKey: ['smart-alerts']
staleTime: 5 * 60 * 1000       // 5 minutos
refetchInterval: 5 * 60 * 1000  // Auto refresh a cada 5 minutos
retry: 2
retryDelay: exponential backoff
```

### Queries Principais

#### 1. Low Stock Products
```sql
-- RPC: get_low_stock_products
SELECT id, name, stock_quantity, min_stock
FROM products 
WHERE stock_quantity <= min_stock OR stock_quantity = 0
ORDER BY stock_quantity ASC
LIMIT 50
```

#### 2. Accounts Receivable
```sql
SELECT ar.*, c.name as customer_name
FROM accounts_receivable ar
INNER JOIN customers c ON ar.customer_id = c.id
WHERE ar.status = 'open' 
  AND ar.due_date < CURRENT_DATE
ORDER BY ar.due_date ASC
```

#### 3. Inactive Customers
```sql
SELECT id, name, last_purchase
FROM customers
WHERE (last_purchase < CURRENT_DATE - INTERVAL '60 days' 
       OR last_purchase IS NULL)
  AND is_active = true
LIMIT 100
```

#### 4. Dead Stock Analysis
```sql
SELECT p.id, p.name, p.price, p.stock_quantity
FROM products p
LEFT JOIN sale_items si ON p.id = si.product_id
LEFT JOIN sales s ON si.sale_id = s.id 
  AND s.created_at > CURRENT_DATE - INTERVAL '30 days'
WHERE p.price > 50 
  AND p.stock_quantity > 0 
  AND s.id IS NULL
```

## üé® Componente AlertsPanel

### Configura√ß√£o Visual

```typescript
const severityConfig = {
  critical: {
    color: 'text-red-400',
    bgColor: 'bg-red-500/10',
    borderColor: 'border-red-500/30',
    icon: XCircle
  },
  warning: {
    color: 'text-amber-400',
    bgColor: 'bg-amber-500/10',
    borderColor: 'border-amber-500/30',
    icon: AlertTriangle
  },
  info: {
    color: 'text-blue-400',
    bgColor: 'bg-blue-500/10',
    borderColor: 'border-blue-500/30',
    icon: Info
  }
};
```

### Props Interface
```typescript
interface AlertsPanelProps {
  items?: AlertItem[];           // Legacy support
  className?: string;
  maxItems?: number;             // Default: 6
  previewActivities?: RecentActivity[];
  cardHeight?: number;           // Para alinhamento
}
```

## üîÑ Sistema de Navega√ß√£o

### Padr√£o de URLs

| Tipo de Alerta | URL Pattern | Par√¢metros Suportados |
|----------------|-------------|----------------------|
| Estoque | `/inventory?filter={filter}` | `zero-stock`, `low-stock`, `dead-stock` |
| Financeiro | `/reports?tab=financial&filter={filter}` | `overdue-30`, `overdue` |
| CRM | `/customers?filter={filter}` | `inactive-60d` |
| Geral | `/reports?tab={tab}&period={days}` | `sales`, `inventory`, `crm`, `financial` |

### Implementa√ß√£o de Filtros

#### FinancialReportsSection
```typescript
// Leitura de par√¢metros URL
useEffect(() => {
  const searchParams = new URLSearchParams(location.search);
  const filterParam = searchParams.get('filter');
  
  if (filterParam && ['overdue-30', 'overdue', 'all'].includes(filterParam)) {
    setActiveFilter(filterParam);
  }
}, [location.search]);

// Query com filtros
const { data: accountsReceivable } = useQuery({
  queryKey: ['accounts-receivable', activeFilter],
  queryFn: async () => {
    // Aplicar filtros baseados no activeFilter
    if (activeFilter === 'overdue-30') {
      return processedData.filter(item => item.days_overdue > 30);
    }
    return processedData;
  }
});
```

## üìà M√©tricas e Monitoramento

### Contadores por Severidade
```typescript
const criticalCount = alerts.filter(a => a.severity === 'critical').length;
const warningCount = alerts.filter(a => a.severity === 'warning').length;
const infoCount = alerts.filter(a => a.severity === 'info').length;
```

### Ordena√ß√£o por Prioridade
```typescript
const severityOrder = { critical: 0, warning: 1, info: 2 };
alerts.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);
```

## üõ†Ô∏è Guia para Implementa√ß√£o de Novos Alertas

### 1. Definir Crit√©rios do Alerta
- **Severidade:** critical | warning | info
- **Condi√ß√£o SQL:** Query espec√≠fica
- **Navega√ß√£o:** URL de destino
- **Threshold:** Valores m√≠nimos para triggering

### 2. Adicionar Query no useSmartAlerts
```typescript
// Template para novo alerta
try {
  const { data: newAlertData, error } = await supabase
    .from('table_name')
    .select('required_fields')
    .condition_filters();

  if (!error && newAlertData && newAlertData.length > threshold) {
    alerts.push({
      id: 'unique-alert-id',
      severity: 'warning', // ou 'critical' | 'info'
      title: `${newAlertData.length} items need attention`,
      description: 'Detailed description',
      href: '/destination?filter=alert-filter',
      count: newAlertData.length,
      icon: 'üö®'
    });
  }
} catch (error) {
  console.error('Error fetching new alert:', error);
}
```

### 3. Implementar Navega√ß√£o
- Adicionar suporte a filtros na p√°gina destino
- Implementar leitura de par√¢metros URL
- Atualizar queries para aplicar filtros

### 4. Testar Completamente
- Verificar queries SQL
- Testar navega√ß√£o
- Validar filtros
- Confirmar performance

## üîí Seguran√ßa e Valida√ß√£o

### Valida√ß√£o de Filtros
```typescript
// Whitelist de filtros v√°lidos
const validFilters = {
  inventory: ['zero-stock', 'low-stock', 'dead-stock'],
  financial: ['overdue-30', 'overdue', 'all'],
  customers: ['inactive-60d', 'active-30d'],
  reports: ['sales', 'inventory', 'crm', 'financial']
};

// Valida√ß√£o antes de aplicar
if (filterParam && validFilters[section].includes(filterParam)) {
  setActiveFilter(filterParam);
}
```

### RLS Policies
Todos os alertas respeitam as Row Level Security policies do Supabase:
- **Admin:** Acesso a todos os alertas
- **Employee:** Alertas operacionais (exceto financeiros sens√≠veis)
- **Delivery:** Alertas relacionados apenas a entregas

## ‚ö° Performance e Otimiza√ß√£o

### Cache Strategy
- **Smart Alerts:** 5 minutos de cache
- **Individual Queries:** Cache espec√≠fico por tipo
- **Background Refresh:** Autom√°tico sem bloquear UI

### Lazy Loading
```typescript
// Carregamento sob demanda
const { data, isLoading } = useSmartAlerts();

// Hooks espec√≠ficos para casos de uso
export function useLowStockAlerts() {
  const { data } = useSmartAlerts();
  return data?.alerts.filter(alert => 
    alert.id === 'low-stock' || alert.id === 'zero-stock'
  ) || [];
}
```

## üìù Changelog

### v1.0.0 - Sistema Base
- ‚úÖ Alertas de estoque (zero e baixo)
- ‚úÖ Alertas financeiros (contas em atraso)
- ‚úÖ Alertas de CRM (clientes inativos)
- ‚úÖ Navega√ß√£o contextual implementada
- ‚úÖ Filtros por URL funcionais

### Pr√≥ximas Implementa√ß√µes
- üîÑ Alertas de delivery em atraso
- üîÑ Alertas de vendas por meta
- üîÑ Alertas de produtos pr√≥ximos ao vencimento
- üîÑ Notifica√ß√µes push para alertas cr√≠ticos

## üö® Considera√ß√µes Importantes

### Evitar Duplica√ß√µes
1. **Verificar alertas existentes** antes de implementar novos
2. **Reutilizar queries RPC** quando poss√≠vel
3. **Padronizar navega√ß√£o** seguindo patterns estabelecidos
4. **Validar performance** de novas queries

### Boas Pr√°ticas
- Sempre usar dados reais do sistema
- Implementar cache adequado (5-15 minutos)
- Adicionar tratamento de erro
- Seguir padr√µes de severity estabelecidos
- Documentar novas queries SQL
- Testar com dados de produ√ß√£o

### Thresholds Recomendados
- **Critical:** Problemas que impedem opera√ß√£o
- **Warning:** Situa√ß√µes que precisam aten√ß√£o
- **Info:** Monitoramento e insights

---

**√öltima atualiza√ß√£o:** Agosto 2025  
**Vers√£o do Sistema:** v2.0.0  
**Status:** Produ√ß√£o Ativa ‚úÖ

####EXEMPLOD DE USO ALERTA ATUAL:

Perfeito! Vejo a imagem do alerta no dashboard. Deixe-me explicar detalhadamente o que este alerta significa:

  üö® An√°lise do Alerta Financeiro

  üìã Informa√ß√µes do Alerta:

  - T√≠tulo: "R$ 2617,90 em atraso +30 dias"
  - Descri√ß√£o: "6 contas em atraso"
  - Detalhes: "6 items"
  - Severidade: WARNING (√≠cone amarelo ‚ö†Ô∏è)

  üí° Significado Detalhado:

  Este alerta indica que o sistema identificou uma situa√ß√£o financeira que requer aten√ß√£o:

  1. üí∞ Valor Total: R$ 2.617,90
    - Soma de todas as contas em atraso superior a 30 dias
    - Representa dinheiro que deveria ter sido recebido h√° mais de um m√™s
  2. üìÖ Per√≠odo de Atraso: +30 dias
    - Contas com vencimento superior a 30 dias corridos
    - Considerado atraso "cr√≠tico" para fluxo de caixa
  3. üìä Quantidade: 6 contas
    - S√£o 6 clientes diferentes em situa√ß√£o de inadimpl√™ncia
    - Cada conta representa um cliente espec√≠fico
  4. üéØ Impacto no Neg√≥cio:
    - Fluxo de Caixa: Dinheiro que falta no caixa da empresa
    - Relacionamento: Clientes que precisam de cobran√ßa
    - Gest√£o: Situa√ß√£o que requer a√ß√£o imediata

  üîç Como o Sistema Calcula Este Alerta:

  Baseado no c√≥digo do useSmartAlerts.ts (linhas 82-97):

  -- Query executada pelo sistema:
  SELECT amount, due_date FROM accounts_receivable
  WHERE status = 'open'
    AND due_date < (CURRENT_DATE - INTERVAL '30 days')

  Processamento:
  1. Sistema busca na tabela accounts_receivable
  2. Filtra contas com status "open" (em aberto)
  3. Identifica contas vencidas h√° mais de 30 dias
  4. Soma os valores: R$ 2.617,90
  5. Conta os registros: 6 contas

  üéØ A√ß√£o Recomendada:

  Quando clicar neste alerta, o usu√°rio ser√° direcionado para:
  - URL: /reports?tab=financial&filter=overdue-30
  - Destino: Aba "Financeiro & Fluxo" dos relat√≥rios
  - Visualiza√ß√£o: Tabela filtrada mostrando apenas essas 6 contas espec√≠ficas

  O que o usu√°rio ver√°:
  - Lista detalhada dos 6 clientes inadimplentes
  - Valores individuais de cada conta
  - Datas de vencimento espec√≠ficas
  - Quantos dias cada conta est√° em atraso
  - Op√ß√µes para a√ß√£o (cobran√ßa, contato, etc.)

  üìà Contexto Empresarial:

  Para uma empresa com R$ 165.700,00 em estoque:
  - R$ 2.617,90 representa ~1,6% do valor total
  - 6 contas sugerem problema recorrente de cobran√ßa
  - Situa√ß√£o administr√°vel, mas que requer aten√ß√£o

  üö® N√≠veis de Gravidade:

  - üü¢ Normal: Contas em dia
  - üü° Aten√ß√£o: 1-30 dias de atraso
  - üü† WARNING: +30 dias (atual) ‚ö†Ô∏è
  - üî¥ CRITICAL: +90 dias

  Este alerta est√° em n√≠vel WARNING porque indica uma situa√ß√£o que precisa de a√ß√£o, mas n√£o √© uma emerg√™ncia cr√≠tica para o neg√≥cio.

  O sistema est√° funcionando corretamente ao detectar e alertar sobre essa situa√ß√£o financeira que requer gest√£o ativa! üìä